<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">

        <title>Running Key</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="js/functions.js"></script>

        <link rel="stylesheet" href="css/style.css">

    </head>
    <body>
      
        <div class="input-div">
            <h1>Running Key Cryptanalysis</h1>
            <br>
            <h2>Ciphertext:</h2>
            <textarea name="ciphertext" id="ciphertext" class="ciphertext-input" cols="30" rows="10"></textarea>

            <h2>Crib:</h2>
            <textarea name="crib" id="crib" class="crib-input" cols="20" rows="1"></textarea>
            <br><br>
            <button id='cryptanalyze'>Begin Cryptanalysis</button>
            <p>Note: This will reset any progress you have made.</p>
        </div>

        <div class="container" id="container">
        </div>

        <div>
            <br>
            <button id='shift-left'>Shift Left</button>
            <button id='shift-right'>Shift Right</button>
            <button id='clear-plaintext'>Clear Plaintext</button>
        </div>

        <script>

            $(document).ready( () => {

                // Obtaining the ciphertext and crib from the text boxes
                var ciphertext = $('#ciphertext').val();
                var crib = $('#crib').val();

                // Removing any spaces
                ciphertext = ciphertext.replace(/\s/g, '');
                crib = crib.replace(/\s/g, '');

                // Creating the arrays
                var ciphertext = ciphertext.split('');
                ciphertext = to_uppercase(ciphertext);
                var crib = crib.split('');
                var plaintext = create_plaintext(ciphertext, crib);
                var key = create_key(ciphertext);

                // Keeping track of the crib
                var crib_index = 0;
                var crib_length = crib.length;

                // Initially writing the arrays to the page
                write(ciphertext, plaintext, key);

                // Given the plaintext array, this function will update it's contents to the page.
                function update_plaintext(plaintext) {
                    plaintext = fill_plaintext(plaintext, ciphertext, key);
                    //console.log("New plaintext: " + plaintext)

                    for (let i = 0; i < plaintext.length; i++) {
                        document.getElementById(`${i}`).value = plaintext[i];
                    }
                }

                // Given the key array, this function will update it's contents to the page.
                function update_key(key) {

                    // Getting the latest version of the key from the backend
                    key = fill_key(plaintext, ciphertext, key);
                    //console.log("New key: " + key)


                    // Displaying the new key values to the page
                    // Note, unlike the plaintext, we do not access the table's cell by .value, but instead we use .innerHTML since this is not an input cell
                    for (let i = 0; i < key.length; i++) {
                        document.getElementById(`key${i}`).value = key[i];
                    }
                }

                // Allowing the user to initially write the ciphertext and plaintext to the page
                $('#cryptanalyze').click( () => {

                    // To do this, we really only need to reload the page.
                    window.location.reload();

                    // Disable the cryptanalze button, as the information only needs to be written once.
                    document.getElementById('cryptanalyze').disabled = 'disabled';

                });

                // Shifting the plaintext right
                $('#shift-right').click( () => {

                    // Saving a copy of the original plaintext
                    var original_plaintext = plaintext;
                    
                    plaintext = shift_array_right(plaintext);
                    key = shift_array_right(key)

                    // If the array was shifted right, update the crib index
                    if (compare_array(plaintext, original_plaintext) == false) {
                        crib_index++;
                    }
                    console.log(`Crib Index: ${crib_index}`)
                    
                    // The order in which these are called ensures that the plaintext will never be changed based on shifting.
                    update_key(key);
                    update_plaintext(plaintext);
                });

                // Shifting the plaintext left
                $('#shift-left').click( () => {

                    // Saving a copy of the original plaintext
                    var original_plaintext = plaintext;

                    plaintext = shift_array_left(plaintext);
                    key = shift_array_left(key);

                    // If the array was shifted left, update the crib index
                    if (compare_array(plaintext, original_plaintext) == false) {
                        crib_index--;
                    }
                    console.log(`Crib Index: ${crib_index}`)

                    update_key(key);
                    update_plaintext(plaintext);
                });

                // Clearing the plaintext and the key
                $('#clear-plaintext').click( () => {
                    for (let i = 0; i < plaintext.length; i++) {
                        plaintext[i] = "";
                        key[i] = "";
                    }
                    update_plaintext(plaintext);
                    update_key(key);
                });

                // Listening for user input
                for (let i = 0; i < plaintext.length; i++) {

                    // Plaintext Changes
                    document.getElementById(`${i}`).addEventListener("keydown", (e) => {
                        
                        // Getting the key that was pressed. We will assume that this is a letter.
                        var letter = e.key;

                        // Checking for invalid keys
                        // Todo: Add in functionality to move right if the right arrow is pushed, and vice versa for the left arrow. Maybe convert it to a tab.
                        if (letter == "ArrowRight" || letter == "ArrowLeft" || letter == "ArrowUp" || letter == "ArrowDown" || letter == "Tab") {
                            console.log("Invalid Letter: " + letter);
                            return;
                        }

                        // If the user is attempting to erase a letter, we must also erase the key letter corresponding to it.
                        if (letter == "Backspace") {
                            plaintext[i] = "";
                            key[i] = "";
                            update_key(key);
                        }

                        // If the user just enters in a normal, valid letter.
                        else {
                            plaintext[i] = letter;
                            update_key(key);
                        }
                    });

                    // Key Changes
                    document.getElementById(`key${i}`).addEventListener("keydown", (e) => {
                        
                        // Getting the key that was pressed. We will assume that this is a letter.
                        var letter = e.key;

                        // Checking for invalid keys
                        // Todo: Add in functionality to move right if the right arrow is pushed, and vice versa for the left arrow. Maybe convert it to a tab.
                        if (letter == "ArrowRight" || letter == "ArrowLeft" || letter == "ArrowUp" || letter == "ArrowDown" || letter == "Tab") {
                            console.log("Invalid Letter: " + letter);
                            return;
                        }

                        // If the user is attempting to erase a letter, we must also erase the key letter corresponding to it.
                        if (letter == "Backspace") {
                            plaintext[i] = "";
                            key[i] = "";
                            update_plaintext(plaintext);
                        }

                        // If the user just enters in a normal, valid letter.
                        else {
                            // Getting the indexes of every letter in the crib, within the plaintext array.
                            var crib_placements = find_crib_placement(plaintext, crib, crib_index);
                            // console.log(`Crib Indexes: ${crib_placements}`);

                            // If the crib is changed through a key letter edit, then warn the user:
                            if (crib_placements.includes(i)) {
                                alert("Warning: The previous edit you made changed the crib. Please ensure that this is what you wanted to do.");
                            }

                            key[i] = letter;
                            update_plaintext(plaintext);
                        }
                    });
                }
            });


            // Function that generates the initial table that will be shown on the web page.
            // This is only called once
            function write(ciphertext, plaintext, key) {
                var myTableDiv = document.getElementById("container")
                var table = document.createElement('TABLE')
                var tableBody = document.createElement('TBODY')

                table.appendChild(tableBody);

                // Ciphertext
                var tr = document.createElement('TR');
                tr.id = "ciphertext_row";
                tableBody.appendChild(tr);
                for (i = 0; i < ciphertext.length; i++) {
                    var th = document.createElement('TH')
                    th.id = `ciphertext${i}`;
                    th.appendChild(document.createTextNode(ciphertext[i]));
                    tr.appendChild(th);
                }

                // Plaintext
                var tr = document.createElement('TR');
                tr.id = "plaintext_row";
                tableBody.appendChild(tr);
                for (i = 0; i < ciphertext.length; i++) {
                    var td = document.createElement('TD')
                    var element = document.createElement('INPUT');
                    element.maxLength = 1;
                    element.value = plaintext[i];
                    element.id = `${i}`

                    td.appendChild(element);
                    tr.appendChild(td);
                }

                // Key (input)
                key = fill_key(plaintext, ciphertext, key);
                var tr = document.createElement('TR');
                tr.id = "key_row";
                tableBody.appendChild(tr);
                for (i = 0; i < ciphertext.length; i++) {
                    var td = document.createElement('TD')
                    var element = document.createElement('INPUT');
                    element.maxLength = 1;
                    element.value = key[i];
                    element.id = `key${i}`;
                    
                    td.appendChild(element);
                    tr.appendChild(td);
                }

                // Key (no input)
                // key = fill_key(plaintext, ciphertext, key);
                // var tr = document.createElement('TR');
                // tr.id = "key_row";
                // tableBody.appendChild(tr);
                // for (i = 0; i < ciphertext.length; i++) {
                //     var td = document.createElement('TD')
                //     td.id = `key${i}`;
                //     td.appendChild(document.createTextNode(key[i]));
                //     tr.appendChild(td);
                // }

                // Appending the new data to the table
                myTableDiv.appendChild(table)
            }
    
        </script>

    </body>

</html>